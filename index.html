<script>
  const FIXE_PAR_PAX = 18;        // commission fixe par passager
  const COMMISSION_RATE = 0.295;  // commission variable

  const PAYE_TVA = [
    { country: 'DE', rate: 0.19 },
    { country: 'CH', rate: 0.07 },
    { country: 'AT', rate: 0.20 },
    { country: 'GB', rate: 0.20 },
    { country: 'FR', rate: 0.20 },
    { country: 'BE', rate: 0.21 },
    { country: 'BG', rate: 0.20 },
    { country: 'CZ', rate: 0.21 },
    { country: 'DK', rate: 0.25 },
    { country: 'ES', rate: 0.21 },
    { country: 'FI', rate: 0.24 },
    { country: 'GR', rate: 0.24 },
    { country: 'HU', rate: 0.27 },
    { country: 'IE', rate: 0.23 },
    { country: 'IT', rate: 0.22 },
    { country: 'LU', rate: 0.17 },
    { country: 'NL', rate: 0.21 },
    { country: 'NO', rate: 0.25 },
    { country: 'PL', rate: 0.23 },
    { country: 'PT', rate: 0.23 },
    { country: 'SE', rate: 0.25 },
    { country: 'SK', rate: 0.20 },
    { country: 'IS', rate: 0.24 },
    { country: 'RE', rate: 0.085 },
    { country: 'MQ', rate: 0.085 },
    { country: 'GP', rate: 0.085 },
    { country: 'PF', rate: 0.16 },
    { country: 'GY', rate: 0 },
    { country: 'YT', rate: 0 },
    { country: 'PM', rate: 0 },
    { country: 'WF', rate: 0 },
    { country: 'MF', rate: 0 },
    { country: 'NC', rate: 0 }
  ];

  // Remplir selects pays, DE, CH, AT, GB, FR en haut
  function remplirSelectPays(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '';

    const prioritaires = ['DE', 'CH', 'AT', 'GB', 'FR'];
    const paysPrioritaires = PAYE_TVA.filter(p => prioritaires.includes(p.country));
    const autresPays = PAYE_TVA.filter(p => !prioritaires.includes(p.country))
      .sort((a,b) => a.country.localeCompare(b.country));

    for (const p of paysPrioritaires) {
      const opt = document.createElement('option');
      opt.value = p.country;
      opt.textContent = `${p.country} (TVA ${Math.round(p.rate*100)}%)`;
      select.appendChild(opt);
    }
    const sep = document.createElement('option');
    sep.disabled = true;
    sep.textContent = '──────────';
    select.appendChild(sep);
    for (const p of autresPays) {
      const opt = document.createElement('option');
      opt.value = p.country;
      opt.textContent = `${p.country} (TVA ${Math.round(p.rate*100)}%)`;
      select.appendChild(opt);
    }
  }

  // TVA par pays
  function getTvaRate(country) {
    const found = PAYE_TVA.find(p => p.country === country);
    return found ? found.rate : 0.20; // défaut 20%
  }

  // Arrondi à la hausse
  function arrondiHaut(x) {
    return Math.ceil(x);
  }
  // Arrondi à la baisse
  function arrondiBas(x) {
    return Math.floor(x);
  }

  // --- Calculateur 1 corrigé ---
  function updateCalculateur1() {
    const prixAvion = parseFloat(document.getElementById('prixAvion').value);
    const tempsVol = parseFloat(document.getElementById('tempsVol').value);
    const coutAdditionnel = parseFloat(document.getElementById('coutAdditionnel').value);
    const pax = parseInt(document.getElementById('pax').value);
    const pilotFFA = document.getElementById('pilotFFAPilote').checked;
    const country = document.getElementById('country1').value;
    const tvaRate = getTvaRate(country);

    document.getElementById('prixAvionValue').innerText = prixAvion;
    document.getElementById('tempsVolValue').innerText = tempsVol;
    document.getElementById('coutAdditionnelValue').innerText = coutAdditionnel;
    document.getElementById('paxValue').innerText = pax;

    const dureeHeure = tempsVol / 60;
    const coutVolHT = prixAvion * dureeHeure;

    const commissionFixe = FIXE_PAR_PAX * pax;
    const commissionVariable = COMMISSION_RATE;

    // Part HT passagers sans surcoût pilot FFA
    let partPassagersHT = (coutVolHT + coutAdditionnel - commissionFixe) / (1 + commissionVariable);
    partPassagersHT = arrondiHaut(partPassagersHT);

    // Commission variable arrondie à la hausse
    const commissionVarMontant = arrondiHaut(partPassagersHT * commissionVariable);

    // TVA arrondie à la hausse
    const montantTVA = arrondiHaut(partPassagersHT * tvaRate);

    // Prix TTC par passager sans surcoût FFA
    const prixParPassagerSansSurcout = partPassagersHT + montantTVA;

    // Surcoût pilot FFA, ajouté à la fin (hors TVA et commission)
    const surcoutPilotFFA = pilotFFA ? 5 * pax : 0;

    // Prix total TTC pour tous les passagers
    const prixTTCTotalPassagers = arrondiHaut((prixParPassagerSansSurcout * pax) + surcoutPilotFFA);

    // Prix TTC par passager avec surcoût réparti (arrondi à la hausse)
    const prixParPassagerAvecSurcout = arrondiHaut(prixTTCTotalPassagers / pax);

    document.getElementById('resultatCalculateur1').innerHTML =
      `- Prix TTC par passager : ${prixParPassagerAvecSurcout} €<br>` +
      `- Prix TTC pour tout le passager : ${prixTTCTotalPassagers} €`;

    document.getElementById('detailsCalculateur1').textContent =
      `Détail calcul:\n` +
      `- Coût vol HT total : ${coutVolHT.toFixed(2)} €\n` +
      `- Coût additionnel : ${coutAdditionnel.toFixed(2)} €\n` +
      `- Surcoût pilot FFA (hors TVA et commission) : ${surcoutPilotFFA.toFixed(2)} €\n` +
      `- Commission fixe : ${commissionFixe.toFixed(2)} €\n` +
      `- Commission variable (arrondi haut) : ${commissionVarMontant.toFixed(2)} €\n` +
      `- TVA (arrondi haut) : ${montantTVA.toFixed(2)} €`;
  }

  // --- Calculateur 2 inchangé ---
  function updateCalculateur2() {
    const prixTotalTTC = parseFloat(document.getElementById('prixTotalSlider').value);
    const pax = parseInt(document.getElementById('pax2').value);
    const pilotFFA = document.getElementById('pilotFFA2').checked;
    const country = document.getElementById('country2').value;
    const tvaRate = getTvaRate(country);

    document.getElementById('prixTotalValue').innerText = prixTotalTTC;
    document.getElementById('pax2Value').innerText = pax;

    const surcoutPilotFFA = pilotFFA ? 5 * pax : 0;

    let prixSansSurcout = prixTotalTTC - surcoutPilotFFA;

    const commissionFixe = FIXE_PAR_PAX * pax;
    const A = 1 + (1 + tvaRate) * COMMISSION_RATE;
    const B = (1 + tvaRate) * commissionFixe;

    let partPassagersHT = (prixSansSurcout - B) / A;

    partPassagersHT = arrondiBas(partPassagersHT);

    document.getElementById('resultatCalculateur2').textContent = `Part HT total passagers : ${partPassagersHT} €`;

    document.getElementById('detailsCalculateur2').textContent =
      `Détail calcul:\n` +
      `- Prix total TTC : ${prixTotalTTC} €\n` +
      `- Surcoût pilot FFA TTC : ${surcoutPilotFFA} €\n` +
      `- Prix TTC sans surcoût : ${prixSansSurcout.toFixed(2)} €\n` +
      `- Commission fixe TTC : ${(commissionFixe * (1 + tvaRate)).toFixed(2)} €\n` +
      `- Coefficient A : ${A.toFixed(3)}\n` +
      `- Coefficient B : ${B.toFixed(2)}\n` +
      `- Part passagers HT (arrondi bas) : ${partPassagersHT} €`;
  }

  remplirSelectPays('country1');
  remplirSelectPays('country2');

  // Valeurs par défaut pays
  document.getElementById('country1').value = 'FR';
  document.getElementById('country2').value = 'FR';

  updateCalculateur1();
  updateCalculateur2();
</script>
