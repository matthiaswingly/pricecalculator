<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calculateur Prix Vol</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 1em auto;
      padding: 0 10px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-size: 0.9em;
    }
    input[type="range"], input[type="number"], select {
      width: 100%;
      margin-top: 5px;
      padding: 6px;
      box-sizing: border-box;
    }
    .slider-value {
      font-size: 0.85em;
      margin-top: 4px;
      font-style: italic;
    }
    .result {
      margin-top: 15px;
      font-weight: bold;
      color: #2a5;
    }
    .details {
      font-size: 0.85em;
      color: #555;
      margin-top: 10px;
      background: #e8f0e8;
      padding: 8px;
      border-radius: 5px;
      white-space: pre-line;
      line-height: 1.3em;
    }
    h2 {
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
  </style>
</head>
<body>

<h2>✈️ Calculateur 1 : Prix du vol à partir du prix horaire</h2>

<label for="prixAvion">Prix avion par heure (€) :</label>
<input type="range" id="prixAvion" min="10" max="2000" value="200" step="10" oninput="updateCalculateur1()">
<div class="slider-value">Prix avion : <span id="prixAvionValue">200</span> €/h</div>

<label for="tempsVol">Temps de vol (minutes) :</label>
<input type="range" id="tempsVol" min="10" max="150" value="60" step="5" oninput="updateCalculateur1()">
<div class="slider-value">Temps vol : <span id="tempsVolValue">60</span> min</div>

<label for="coutAdditionnel">Coût additionnel (€) :</label>
<input type="range" id="coutAdditionnel" min="0" max="300" value="0" step="5" oninput="updateCalculateur1()">
<div class="slider-value">Coût additionnel : <span id="coutAdditionnelValue">0</span> €</div>

<label for="pax">Nombre de passagers :</label>
<input type="range" id="pax" min="1" max="5" value="1" step="1" oninput="updateCalculateur1()">
<div class="slider-value">Passagers : <span id="paxValue">1</span></div>

<label><input type="checkbox" id="pilotFFAPilote" onchange="updateCalculateur1()"> Pilot FFA (+5 € par passager, sans TVA ni commission)</label>

<label for="country1">Pays (TVA) :</label>
<select id="country1" onchange="updateCalculateur1()"></select>

<div class="result" id="resultatCalculateur1">Prix par passager : 0 €<br>Prix TTC pour tout le passager : 0 €</div>
<div class="details" id="detailsCalculateur1"></div>

<hr>

<h2>✈️ Calculateur 2 : Calcul à partir du prix total TTC</h2>

<label for="prixTotalSlider">Prix total TTC (vol + passagers) (€) :</label>
<input type="range" id="prixTotalSlider" min="50" max="5000" value="500" step="10" oninput="updateCalculateur2()">
<div class="slider-value">Prix total TTC : <span id="prixTotalValue">500</span> €</div>

<label for="pax2">Nombre de passagers :</label>
<input type="range" id="pax2" min="1" max="5" value="1" step="1" oninput="updateCalculateur2()">
<div class="slider-value">Passagers : <span id="pax2Value">1</span></div>

<label><input type="checkbox" id="pilotFFA2" onchange="updateCalculateur2()"> Pilot FFA (+5 € par passager, sans TVA ni commission)</label>

<label for="country2">Pays (TVA) :</label>
<select id="country2" onchange="updateCalculateur2()"></select>

<div class="result" id="resultatCalculateur2">Part HT total passagers : 0 €</div>
<div class="details" id="detailsCalculateur2"></div>

<script>
  const FIXE_PAR_PAX = 18;        // commission fixe par passager
  const COMMISSION_RATE = 0.295;  // commission variable
  const PAYE_TVA = [
    { country: 'DE', rate: 0.19 },
    { country: 'CH', rate: 0.07 },
    { country: 'AT', rate: 0.20 },
    { country: 'GB', rate: 0.20 },
    { country: 'FR', rate: 0.20 },
    // Autres pays en ordre alphabétique
    { country: 'BE', rate: 0.21 },
    { country: 'BG', rate: 0.20 },
    { country: 'CZ', rate: 0.21 },
    { country: 'DK', rate: 0.25 },
    { country: 'ES', rate: 0.21 },
    { country: 'FI', rate: 0.24 },
    { country: 'GR', rate: 0.24 },
    { country: 'HU', rate: 0.27 },
    { country: 'IE', rate: 0.23 },
    { country: 'IT', rate: 0.22 },
    { country: 'LU', rate: 0.17 },
    { country: 'NL', rate: 0.21 },
    { country: 'NO', rate: 0.25 },
    { country: 'PL', rate: 0.23 },
    { country: 'PT', rate: 0.23 },
    { country: 'SE', rate: 0.25 },
    { country: 'SK', rate: 0.20 },
    { country: 'IS', rate: 0.24 },
    { country: 'RE', rate: 0.085 },
    { country: 'MQ', rate: 0.085 },
    { country: 'GP', rate: 0.085 },
    { country: 'PF', rate: 0.16 },
    { country: 'GY', rate: 0 },
    { country: 'YT', rate: 0 },
    { country: 'PM', rate: 0 },
    { country: 'WF', rate: 0 },
    { country: 'MF', rate: 0 },
    { country: 'NC', rate: 0 }
  ];

  // Fonction pour remplir les selects pays en mettant DE, CH, AT, GB, FR en haut
  function remplirSelectPays(selectId) {
    const select = document.getElementById(selectId);
    select.innerHTML = '';

    const prioritaires = ['DE', 'CH', 'AT', 'GB', 'FR'];
    const paysPrioritaires = PAYE_TVA.filter(p => prioritaires.includes(p.country));
    const autresPays = PAYE_TVA.filter(p => !prioritaires.includes(p.country))
      .sort((a,b) => a.country.localeCompare(b.country));

    // Ajouter prioritaires
    for (const p of paysPrioritaires) {
      const opt = document.createElement('option');
      opt.value = p.country;
      opt.textContent = `${p.country} (TVA ${Math.round(p.rate*100)}%)`;
      select.appendChild(opt);
    }
    // Ajouter séparateur
    const sep = document.createElement('option');
    sep.disabled = true;
    sep.textContent = '──────────────';
    select.appendChild(sep);

    // Ajouter autres
    for (const p of autresPays) {
      const opt = document.createElement('option');
      opt.value = p.country;
      opt.textContent = `${p.country} (TVA ${Math.round(p.rate*100)}%)`;
      select.appendChild(opt);
    }
  }

  function getTvaRate(countryCode) {
    const pays = PAYE_TVA.find(p => p.country === countryCode);
    return pays ? pays.rate : 0.19; // défaut 19%
  }

  // Arrondi toujours à la hausse (ceil)
  function arrondiHaut(value) {
    return Math.ceil(value);
  }
  // Arrondi toujours à la baisse (floor)
  function arrondiBas(value) {
    return Math.floor(value);
  }

  // ----------- Calculateur 1 -----------------
  function updateCalculateur1() {
    const prixAvion = parseFloat(document.getElementById('prixAvion').value);
    const tempsVol = parseFloat(document.getElementById('tempsVol').value);
    const coutAdditionnel = parseFloat(document.getElementById('coutAdditionnel').value);
    const pax = parseInt(document.getElementById('pax').value);
    const pilotFFA = document.getElementById('pilotFFAPilote').checked;
    const country = document.getElementById('country1').value;
    const tvaRate = getTvaRate(country);

    document.getElementById('prixAvionValue').innerText = prixAvion;
    document.getElementById('tempsVolValue').innerText = tempsVol;
    document.getElementById('coutAdditionnelValue').innerText = coutAdditionnel;
    document.getElementById('paxValue').innerText = pax;

    // Coût vol base HT (prix par heure * temps en heure)
    const tempsHeures = tempsVol / 60;
    const coutVolBase = prixAvion * tempsHeures;

    // Coût total vol HT (pilote + passagers)
    const coutVolTotalHT = coutVolBase + coutAdditionnel;

    // Parts totales (pilote + pax)
    const totalParts = pax + 1;

    // Part pilote HT = coût total vol HT / totalParts
    const partPiloteHT = coutVolTotalHT / totalParts;

    // Part passagers HT = reste
    const partPassagersHT = coutVolTotalHT - partPiloteHT;

    // Surcoût Pilot FFA, sans TVA ni commission
    const surcoutPilotFFA = pilotFFA ? 5 * pax : 0;

    // Commissions sur part passagers HT
    const commissionFixe = FIXE_PAR_PAX * pax;
    const commissionVariable = Math.ceil(partPassagersHT * COMMISSION_RATE);
    const tvaCommissions = Math.ceil((commissionFixe + commissionVariable) * tvaRate);

    // Prix total TTC pour passagers = part passagers + commissions + TVA + surcoût FFA
    const prixTotalPassagersTTC = partPassagersHT + commissionFixe + commissionVariable + tvaCommissions + surcoutPilotFFA;

    // Prix TTC par passager (arrondi à la hausse)
    const prixParPassager = arrondiHaut(prixTotalPassagersTTC / pax);

    // Prix TTC pour tout le passager (arrondi à la hausse)
    const prixTTCTotalPassagers = arrondiHaut(prixParPassager * pax);

    // Affichage résultats
    document.getElementById('resultatCalculateur1').innerHTML =
      `Prix par passager : ${prixParPassager} €<br>Prix TTC pour tout le passager : ${prixTTCTotalPassagers} €`;

    // Détails
    const detailsTxt =
      `Coût vol base HT (avion * temps) : ${coutVolBase.toFixed(2)} €\n` +
      `Coût additionnel HT : ${coutAdditionnel.toFixed(2)} €\n` +
      `Coût total vol HT : ${coutVolTotalHT.toFixed(2)} €\n` +
      `Parts totales (pilote + passagers) : ${totalParts}\n` +
      `Part pilote HT : ${partPiloteHT.toFixed(2)} €\n` +
      `Part passagers HT : ${partPassagersHT.toFixed(2)} €\n` +
      `Commission fixe (18€/pax) : ${commissionFixe} €\n` +
      `Commission variable (29.5%) : ${commissionVariable} €\n` +
      `TVA commissions (${Math.round(tvaRate*100)}%) : ${tvaCommissions} €\n` +
      `Surcoût Pilot FFA : ${surcoutPilotFFA} €\n` +
      `Prix total TTC passagers (arrondi à la hausse) : ${prixTTCTotalPassagers} €`;

    document.getElementById('detailsCalculateur1').innerText = detailsTxt;
  }

  // ----------- Calculateur 2 -----------------
  function updateCalculateur2() {
    const prixTotalTTC = parseFloat(document.getElementById('prixTotalSlider').value);
    const pax = parseInt(document.getElementById('pax2').value);
    const pilotFFA = document.getElementById('pilotFFA2').checked;
    const country = document.getElementById('country2').value;
    const tvaRate = getTvaRate(country);

    document.getElementById('prixTotalValue').innerText = prixTotalTTC;
    document.getElementById('pax2Value').innerText = pax;

    // Surcoût Pilot FFA
    const surcoutPilotFFA = pilotFFA ? 5 * pax : 0;

    // Prix TTC sans FFA
    const prixSansFFA = prixTotalTTC - surcoutPilotFFA;

    // Commissions
    const commissionFixe = FIXE_PAR_PAX * pax;
    // On enlève TVA sur commissions : TTC = HT + HT*tva → HT = TTC/(1+tva)
    // On estime commissions HT sans TVA
    // Comme TTC commissions = fixe+var + TVA, on estime var commission en HT par itération

    // Part TTC passagers hors commissions et surcout FFA
    const partPassagersTTC = prixSansFFA;

    // Pour trouver part passagers HT (x), on a:
    // prixSansFFA = x + commissions + TVA commissions
    // commissions = fixe + var
    // TVA commissions = (fixe + var) * tvaRate
    // var = x * COMMISSION_RATE

    // donc:
    // prixSansFFA = x + fixe + x*COMMISSION_RATE + (fixe + x*COMMISSION_RATE)*tvaRate
    // prixSansFFA = x + fixe + x*COMMISSION_RATE + fixe*tvaRate + x*COMMISSION_RATE*tvaRate
    // regroupons les termes en x:
    // prixSansFFA - fixe - fixe*tvaRate = x * (1 + COMMISSION_RATE + COMMISSION_RATE*tvaRate)
    // donc
    // x = (prixSansFFA - fixe*(1+tvaRate)) / (1 + COMMISSION_RATE*(1+tvaRate))

    const denom = 1 + COMMISSION_RATE * (1 + tvaRate);
    const numer = partPassagersTTC - commissionFixe * (1 + tvaRate);

    let partPassagersHT = numer / denom;

    if (partPassagersHT < 0) partPassagersHT = 0;

    // Arrondi à la baisse
    partPassagersHT = arrondiBas(partPassagersHT);

    // Affichage résultat
    document.getElementById('resultatCalculateur2').innerHTML =
      `Part HT total passagers (arrondi à la baisse) : ${partPassagersHT} €`;

    // Détails
    const detailsTxt =
      `Prix total TTC (entrée) : ${prixTotalTTC} €\n` +
      `Surcoût Pilot FFA : ${surcoutPilotFFA} €\n` +
      `Prix TTC sans surcoût FFA : ${prixSansFFA} €\n` +
      `Commission fixe : ${commissionFixe} €\n` +
      `TVA appliquée : ${Math.round(tvaRate * 100)} %\n` +
      `Calcul part passagers HT (avant commissions) : ${partPassagersHT} €`;

    document.getElementById('detailsCalculateur2').innerText = detailsTxt;
  }

  // Initialisation selects
  remplirSelectPays('country1');
  remplirSelectPays('country2');
  document.getElementById('country1').value = 'DE';
  document.getElementById('country2').value = 'DE';

  // Initial update
  updateCalculateur1();
  updateCalculateur2();
</script>

</body>
</html>
